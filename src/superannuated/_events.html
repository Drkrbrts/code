<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- #region Sabio Code - You can Fold this region to remove it from sight -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="referrer" content="unsafe-url" />
    <meta name="description" content="Sabio Coding Bootcamp" />
    <meta itemprop="image" content="https://sabio.la/Sabio.png" />
    <link rel="shortcut icon" href="https://sabio.la/Sabio.png" />
    <link rel="icon" type="image/png" href="https://sabio.la/Sabio.png" />
    <!-- Do Not Change the HTML title or anything between this line and the line with the 💘's -->
    <title>Events</title>
    <link href="https://pw.sabio.la/dist/all-site.css" rel="stylesheet" />
    <script src="https://pw.sabio.la/api/js/site"></script>
    <script src="https://unpkg.com/axios@0.19.2/dist/axios.min.js"></script>
    <script src="usersService.js"></script>
    <script src="eventsService.js"></script>
    <script src="CodeSeven-toastr-50092cc/toastr.js"></script>
    <link href="CodeSeven-toastr-50092cc/build/toastr.css" rel="stylesheet" />

    <!-- #endregion -->
    <!-- I 💘 Code, You 💘 Code, We all 💘 Code -->

    <!-- 💡 All your CSS in here -->
    <style>
      #map {
        height: 800px;
        width: 100%;
      }
    </style>
  </head>

  <body class="sabio" data-ins="pw-00">
    <!-- Do Not Edit or Remove this nav element -->
    <nav
      class="do-not-remove navbar navbar-expand-md navbar-dark bg-dark sabio"
    ></nav>

    <nav class="navbar navbar-dark navbar-expand-lg">
      <div class="navbar-header">
        <a class="navbar-brand" href="#">
          <img
            src="/images/Sabio.png"
            alt="sabio logo"
            height="30"
            width="30"
          />
        </a>
      </div>
      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
          <a id="blogsNavLink" class="nav-link" href="home.html">Home</a>
        </li>
        <li class="nav-item active">
          <a id="friendsNavLink" class="nav-link" href="friends.html"
            >Friends</a
          >
        </li>
        <li class="nav-item">
          <a id="techNavLink" class="nav-link" href="techCompanies.html"
            >Tech Co</a
          >
        </li>
        <li class="nav-item">
          <a id="jobsNavLink" class="nav-link" href="jobs.html">Jobs</a>
        </li>
        <li class="nav-item active">
          <a id="eventNavLink" class="nav-link" href="events.html">Events</a>
        </li>
      </ul>
      <ul id="loginRegisterNav" class="navbar-nav d-none">
        <li class="nav-item">
          <a class="nav-link" href="login.html">Login</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="register.html">Register</a>
        </li>
      </ul>
      <div class="ms-auto">
        <button id="logoutSubmitButton" class="btn btn-danger" type="submit">
          Logout
        </button>
        <img
          src="https://bit.ly/3cHWcj3"
          alt="user avatar"
          id="userAvatar"
          height="30"
          width="30"
        />
      </div>
    </nav>

    <div class="container">
      <div class="row">
        <div class="border col-8">
          <h3 id="eventName">Welcome to Events!</h3>
          <h5 id="eventHeadline">
            To see more information select an event on the right.
          </h5>
          <p id="eventSummary"></p>
          <p id="eventDescription"></p>
          <p id="eventAddress"></p>
          <div id="map"></div>
        </div>
        <div class="border col-4">
          <div class="rounded col-12 text-center border">
            <h3>Search</h3>
            <input
              id="inputLatitudeSearch"
              class="col-8"
              placeholder="latitude"
            />
            <input
              id="inputLongitudeSearch"
              class="col-8"
              placeholder="longitude"
            />
            <div class="row">
              <input
                id="inputRadius"
                class="ms-auto col-4"
                placeholder="radius in miles"
              />
              <button
                type="search"
                id="searchGeo"
                class="btn btn-primary me-auto col-4"
              >
                Search
              </button>
            </div>
          </div>
          <div class="border text-center">
            <h3>Upcoming Events</h3>
            <button class="btn btn-primary" id="addNewEventButton">
              New Event
            </button>
            <div class="clone-container"></div>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="addEditEventModal"
      tabindex="-1"
      role="dialog"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Event</h5>
          </div>
          <div class="modal-body">
            <form id="#addEditEventForm" class="rounded">
              <div class="form-group">
                <input type="hidden" id="hiddenInputId" />
              </div>
              <div class="form-group">
                <label for="inputName">Name</label>
                <input typ="text" id="inputName" class="form-control" />
              </div>
              <div class="form-group">
                <label for="inputHeadline">Headline</label>
                <input type="text" id="inputHeadline" class="form-control" />
              </div>
              <div class="form-group">
                <label for="inputDescription">Description</label>
                <input type="text" id="inputDescription" class="form-control" />
              </div>
              <div class="form-group">
                <label for="inputSummary">Summary</label>
                <input type="text" id="inputSummary" class="form-control" />
              </div>
              <div class="form-group">
                <label for="inputSlug">Slug</label>
                <input type="text" id="inputSlug" class="form-control" />
              </div>
              <div class="row">
                <div class="form-group col-6">
                  <label for="inputDateStart">Date Start</label>
                  <input type="text" id="inputDateStart" class="form-control" />
                </div>
                <div class="form-group col-6">
                  <label for="inputDateEnd">Date End</label>
                  <input type="text" id="inputDateEnd" class="form-control" />
                </div>
              </div>
              <div class="row">
                <div class="form-group col-8">
                  <label for="inputAddress">Address</label>
                  <input type="text" id="inputAddress" class="form-control" />
                </div>
                <div class="form-group col-4">
                  <label for="inputZipCode">Zip Code</label>
                  <input type="text" id="inputZipCode" class="form-control" />
                </div>
              </div>
              <div class="row">
                <div class="form-group col-6">
                  <label for="inputLatitude">Latitude</label>
                  <input type="text" id="inputLatitude" class="form-control" />
                </div>
                <div class="form-group col-6">
                  <label for="inputLongitude">Longitude</label>
                  <input type="text" id="inputLongitude" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label for="selectStatusId">StatusId</label>
                <select id="selectStatusId" class="form-select">
                  <option selected>Active</option>
                  <option>NotSet</option>
                  <option>Deleted</option>
                  <option>Flagged</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-primary"
              id="confirmAddEditEventButton"
            >
              Confirm
            </button>
            <!-- <button
              type="button"
              class="btn btn-warning d-none"
              id="confirmEditEventButton"
            >
              Edit
            </button> -->
            <button
              type="buuton"
              class="btn btn-secondary"
              id="closeAddEventModalButton"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Do Not Edit or Remove this footer element -->
    <footer
      class="do-not-remove container-fluid footer mx-auto fb-targert sabio"
    >
      <p class="text-center">© Sabio.la 2019</p>
    </footer>

    <!--👇🏻 All your JavaScript code goes below here inside this script tag 👇🏻 -->
    <script id="candidateCode">
      let googleMap;
      function startUp() {
        console.log("start up");
        $(".do-not-remove").addClass("d-none");
        wireUpHandlers();
      }
      function wireUpHandlers() {
        $(".clone-container").on("click", ".btn-info", onEventInfoButtonClick);
        $(".clone-container").on(
          "click",
          ".btn-warning",
          onEditEventButtonClick
        );
        $("#searchGeo").on("click", onSearchGeoButtonClick);
        $("#addNewEventButton").on("click", onAddNewEventButtonClick);
        $("#closeAddEventModalButton").on(
          "click",
          onCloseAddEditEventModalButtonClick
        );
        $("#confirmAddEditEventButton").on(
          "click",
          onConfirmAddEditEventButtonClick
        );
        // $("#confirmEditEventButton").on("click", onConfirmEditEventButtonClick);
      }
      function onEventInfoButtonClick(e) {
        e.preventDefault();
        var eventAddressStr =
          $(this).closest(".card").data("address") +
          " " +
          $(this).closest(".card").data("zip");

        var latLng = new google.maps.LatLng(
          $(this).closest(".card").data("lat"),
          $(this).closest(".card").data("lng")
        );

        $("#eventName").text($(this).closest(".card").data("name"));
        $("#eventHeadline").text($(this).closest(".card").data("headline"));
        $("#eventSummary").text($(this).closest(".card").data("summary"));
        $("#eventDescription").text(
          $(this).closest(".card").data("description")
        );
        $("#eventAddress").text(eventAddressStr);
        googleMap.setZoom(16);

        //console.log(latLng);
        googleMap.setCenter(latLng);
      }
      function onEditEventButtonClick(e) {
        e.preventDefault();
        //change buttons
        // $("#confirmAddEventButton").addClass("d-none");
        // $("#confirmEditEventButton").removeClass("d-none");

        //fill form
        $("#hiddenInputId").val($(this).closest(".card").data("id"));
        $("#inputName").val($(this).closest(".card").data("name"));
        $("#inputHeadline").val($(this).closest(".card").data("headline"));
        $("#inputDescription").val(
          $(this).closest(".card").data("description")
        );
        $("#inputSummary").val($(this).closest(".card").data("summary"));
        $("#inputSlug").val($(this).closest(".card").data("slug"));
        $("#selectStatusId").val($(this).closest(".card").data("statusId"));
        $("#inputDateStart").val($(this).closest(".card").data("date-start"));
        $("#inputDateEnd").val($(this).closest(".card").data("date-end"));
        $("#inputLatitude").val($(this).closest(".card").data("lat"));
        $("#inputLongitude").val($(this).closest(".card").data("lng"));
        $("#inputZipCode").val($(this).closest(".card").data("zip"));
        $("#inputAddress").val($(this).closest(".card").data("address"));

        $("#addEditEventModal").modal("toggle");
      }
      function onSearchGeoButtonClick(e) {
        e.preventDefault();
        eventsService
          .searchByGeo(
            $("#inputLatitudeSearch").val(),
            $("#inputLongitudeSearch").val(),
            $("#inputRadius").val()
          )
          .then(onSearchByGeoSuccess)
          .catch(onSearchByGeoError);
        function onSearchByGeoSuccess(response) {
          console.log(response);
          renderEventCards(response.data.items);
        }
        function onSearchByGeoError(error) {
          console.log(error);
        }
      }
      function onAddNewEventButtonClick(e) {
        e.preventDefault();
        $("#addEditEventModal").modal("toggle");
      }
      function onCloseAddEditEventModalButtonClick(e) {
        e.preventDefault();
        $("#hiddenInputId").val("");
        $("#addEditEventModal form")[0].reset();
        $("#addEditEventModal").modal("toggle");
      }
      function onConfirmAddEditEventButtonClick(e) {
        e.preventDefault();

        payload = {
          name: $("#inputName").val(),
          headline: $("#inputHeadline").val(),
          description: $("#inputDescription").val(),
          summary: $("#inputSummary").val(),
          slug: $("#inputSlug").val(),
          statusId: $("#selectStatusId").val(),
          metadata: {
            dateStart: $("#inputDateStart").val(),
            dateEnd: $("#inputDateEnd").val(),
            location: {
              address: $("#inputAddress").val(),
              zipCode: $("#inputZipCode").val(),
              latitude: $("#inputLatitude").val(),
              longitude: $("#inputLongitude").val(),
            },
          },
        };

        if ($("#hiddenInputId").val()) {
          payload.id = $("#hiddenInputId").val();
          eventsService
            .update(payload)
            .then(onUpdateEventSuccess)
            .catch(onUpdateEventError);
          function onUpdateEventSuccess(response) {
            console.log(response);
            toastr.success("Edit Successful.");
            $("#hiddenInputId").val("");
            $("#addEditEventModal form")[0].reset();
            $("#addEditEventModal").modal("toggle");
          }
          function onUpdateEventError(error) {
            console.log(error);
            toastr.error("Edit Failed");
          }
        } else {
          eventsService
            .add(payload)
            .then(onAddEventSuccess)
            .catch(onAddEventError);
          function onAddEventSuccess(response) {
            console.log(response);
            toastr.success("Add Successful.");
            $("#hiddenInputId").val("");
            $("#addEditEventModal form")[0].reset();
            $("#addEditEventModal").modal("toggle");
          }
          function onAddEventError(error) {
            console.log(error);
            toastr.error("Add Failed.");
          }
        }
      }
      // function onConfirmEditEventButtonClick(e) {
      //   e.preventDefault();

      //   var payload = {
      //     id: $("#inputHiddenId").val(),
      //     name: $("#inputName").val(),
      //     headline: $("#inputHeadline").val(),
      //     description: $("#inputDescription").val(),
      //     summary: $("#inputSummary").val(),
      //     slug: $("#inputSlug").val(),
      //     statusId: $("#inputStatusId").val(),
      //     metaData: {
      //       dateStart: ("#inputDateStart").val(),
      //       dateEnd: ("#inputDateEnd").val(),
      //       location: {
      //         latitude: ()
      //       }
      //     }
      //   };

      //   eventsService
      //     .update(payload)
      //     .then(onUpdateEventSuccess)
      //     .catch(onUpdateEventError);
      // }
      // function onUpdateEventSuccess(response) {
      //   console.log(response);
      //   toastr.success("Edit Successful.");
      // }
      // function onUpdateEventError(error) {
      //   console.log(error);
      //   toastr.error("Edit Failed");
      // }

      function renderPage() {
        eventsService
          .getPaginatedNotStarted()
          .then(onGetPaginatedNotStartedSuccess)
          .catch(onGetPaginatedNotStartedError);
        function onGetPaginatedNotStartedSuccess(response) {
          console.log(response);
          renderEventCards(response.data.item.pagedItems);
        }
        function onGetPaginatedNotStartedError(error) {
          console.log(error);
        }
      }

      function renderEventCards(eventArr) {
        $(".clone-container").empty();
        jqEventArr = eventArr.map(mapEvent);
        $(".clone-container").append(jqEventArr);
      }
      function mapEvent(event) {
        var templateHtml = $("#eventCardTemplate").html();
        var templateClone = $(templateHtml).clone();

        //data for more information
        $(templateClone).attr("data-id", event.id);
        $(templateClone).attr("data-lat", event.metaData.location.latitude);
        $(templateClone).attr("data-lng", event.metaData.location.longitude);
        $(templateClone).attr("data-name", event.name); //temp?
        $(templateClone).attr("data-headline", event.headline); //temp?
        $(templateClone).attr("data-summary", event.summary); //temp?
        $(templateClone).attr("data-description", event.description);
        $(templateClone).attr("data-slug", event.slug);
        $(templateClone).attr("data-status", event.statusId);
        $(templateClone).attr("data-address", event.metaData.location.address);
        $(templateClone).attr("data-zip", event.metaData.location.zipCode);
        $(templateClone).attr("data-date-start", event.metaData.dateStart);
        $(templateClone).attr("data-date-end", event.metaData.dateEnd);

        //card text
        $(templateClone).find(".card-title").text(event.name);
        $(templateClone).find(".card-subtitle").text(event.headline);
        $(templateClone).find(".card-text").text(event.summary);
        new google.maps.Marker({
          position: {
            lat: event.metaData.location.latitude,
            lng: event.metaData.location.longitude,
          },
          map: googleMap,
        });
        return templateClone;
      }

      function initMap() {
        googleMap = new google.maps.Map(document.getElementById("map"), {
          zoom: 8,
          center: { lat: 25.78916874651175, lng: -80.31692736347901 },
        });
        renderPage();
      }
    </script>

    <script
      async
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDkb-GETdK5ePdQrdcwMqcl7i0nNoDBNfk&callback=initMap"
    ></script>

    <script id="eventCardTemplate" type="text/html">
      <div class="card shadow-lg">
        <div class="card-body text-center">
          <h5 class="card-title">Sample Title</h5>
          <h6 class="card-subtitle">Sample Subtitle</h6>
          <p class="card-text">Sample Summary</p>
          <div class="row">
            <button class="btn btn-info col-4">Info</button>
            <button class="btn btn-warning col-4">Edit</button>
            <button class="btn btn-danger col-4">Delete</button>
          </div>
        </div>
      </div>
    </script>
    <!-- 🛑 Do Not Write Any Code Below here -->
  </body>
</html>
